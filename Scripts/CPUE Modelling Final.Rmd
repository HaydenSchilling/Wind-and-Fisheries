---
title: "CPUE Data Analysis"
output: html_notebook
---

Based upon conversations with Pravin from Stats, use log10 CPUE rather than standardise by estuary/species

Load data and clean up and standardise the winds
```{r}
library(ggplot2)
library(DHARMa)
library(bootpredictlme4)
library(merTools)
library(effects)
library(MuMIn)
library(dplyr)
library(ggeffects)
library(glmmTMB)
library(tweedie)
# Use Log10(CPUE) rather than standardise


# Load Data
mydata <- read.csv("../Data/Full_Data_Modelling_BARRA_by_estuary.csv", header = T) # Full_Data_ModellingV3_by_estuary.csv
# mydata2 <-  read.csv("Full_Data_Modelling.csv", header = T)
# 
# cor.test(mydata$X45_degree_winds, mydata2$X135_degree_winds)
# cor.test(mydata$X135_degree_winds, mydata2$X45_degree_winds)
# cor.test(mydata$X135_degree_winds, mydata2$X135_degree_winds)
# cor.test(mydata$X45_degree_winds, mydata2$X45_degree_winds)
# # NE winds not correlated by SE winds are.....

# Remove Total CPUE
mydata <- subset(mydata, Species != "Total")

### Standardise Winds
my.df <-  mydata %>% group_by(Species) %>% mutate(X45_degree_winds.standardised = as.numeric(scale(X45_degree_winds)),
                           X135_degree_winds.standardised = as.numeric(scale(X135_degree_winds)))

```

Investigate the environmental variation over time and the stability of the CPUE over time
```{r}
head(my.df)

ggplot(my.df, aes(x=Year, y = Drought_Months)) + geom_point() + facet_wrap(~Species)
ggplot(my.df, aes(x=Year, y = CPUE, col= Estuary)) + geom_line() + facet_wrap(~Species, scales = "free_y")

# the next two suggest my scaling of the winds was not good enough.
ggplot(my.df, aes(x=Year, y = X45_degree_winds.standardised, col= Estuary)) + geom_line() + facet_wrap(~Species)#, scales = "free_y")
ggplot(my.df, aes(x=Year, y = X135_degree_winds.standardised, col= Estuary)) + geom_line() + facet_wrap(~Species)#, scales = "free_y")


```



Do full model for all species

```{r}
m7 <- glmmTMB(Catch ~ poly(X135_degree_winds.standardised, degree = 2) + 
       poly(X45_degree_winds.standardised, degree = 2) +
       X135_degree_winds.standardised:X45_degree_winds.standardised+
        Estuary_Type *Drought_Months + (1|Estuary) + (1|Species), family = tweedie(),
       data = my.df, offset = log10(Effort_days))
AIC(m7) # -38.18
performance::r2(m7) # 0.08

simulationOutput <- simulateResiduals(fittedModel = m7, n = 250)
plot(simulationOutput)
hist(residuals(m7))

car::Anova(m7)
summary(m7)
plot(m7)
hist(resid(m7))
lattice::qqmath(m7)
```

Save model checking plots - These were combined manually in Inkscape later
```{r}
png("../plots/Model checks/Mulitspecies model 1.png", width = 21, height = 14.8, units = "cm", res = 600)
plot(m7)
dev.off()

png("../plots/Model checks/Mulitspecies model 2.png", width = 21, height = 14.8, units = "cm", res = 600)
hist(resid(m7))
dev.off()

png("../plots/Model checks/Mulitspecies model 3.png", width = 21, height = 14.8, units = "cm", res = 600)
lattice::qqmath(m7)
dev.off()
```



Effect size plot
```{r}
fastdisp(m7)

feEx <- FEsim(m7, 1000)
cbind(feEx[,1] , round(feEx[, 2:4], 3))


plotFEsim(feEx) + 
  theme_bw() + labs(title = "Coefficient Plot of InstEval Model", 
                    x = "Median Effect Estimate", y = "Evaluation Rating")
```


```{r}
plot(ggpredict(m7, terms = "X45_degree_winds.standardised [all]"))
plot(ggpredict(m7, terms = "X135_degree_winds.standardised [all]"))
plot(ggpredict(m7, terms = "Drought_Months [all]"))
```



Now for some species specific Models
Bream First
Prepare Data
```{r}
bream <- subset(my.df, Species == "Bream")

```

Model
```{r}
m1 <- lmer(log10(CPUE) ~ poly(X135_degree_winds.standardised, degree = 2) + 
             poly(X45_degree_winds.standardised, degree = 2) +
             X135_degree_winds.standardised:X45_degree_winds.standardised+
             Estuary_Type * Drought_Months + (1|Estuary), data = bream)
r.squaredGLMM(m1) # 0.266
AIC(m1) # 43.17
```

Check assumptions
```{r}
simulationOutput <- simulateResiduals(fittedModel = m1, n = 250)
plot(simulationOutput)

# histograms
hist(simulationOutput$fittedResiduals)
```

Model checking plots - note these were combined in Inkscape manually later
```{r}
png("../plots/Model checks/Bream model 1.png", width = 21, height = 14.8, units = "cm", res = 600)
plot(m1)
dev.off()

png("../plots/Model checks/Bream model 2.png", width = 21, height = 14.8, units = "cm", res = 600)
hist(resid(m1))
dev.off()

png("../plots/Model checks/Bream model 3.png", width = 21, height = 14.8, units = "cm", res = 600)
lattice::qqmath(m1)
dev.off()
```


Check significance
```{r}
anova(m1)

summary(m1)
```


Effect size plot
```{r}
fastdisp(m1)

feEx <- FEsim(m1, 1000)
cbind(feEx[,1] , round(feEx[, 2:4], 3))


plotFEsim(feEx) + 
  theme_bw() + labs(title = "Coefficient Plot of InstEval Model", 
                    x = "Median Effect Estimate", y = "Evaluation Rating")
```

```{r}
plot(ggpredict(m1, terms = "X45_degree_winds.standardised [all]"))
plot(ggpredict(m1, terms = "X135_degree_winds.standardised [all]"))
plot(ggpredict(m1, terms = "Drought_Months [all]"))
```



##Now Mullet##
Prepare Data
```{r}
mullet <- subset(my.df, Species == "Mullet")

p2 <- ggplot(mullet, aes(x = X135_degree_winds.standardised,y = X45_degree_winds.standardised, size = log10(CPUE))) + geom_point(alpha = 0.1) +
  theme_classic() + labs(title = "CPUE by lagged Winds")
p2
```

Model
```{r}
m2 <- lmer(log10(CPUE) ~ poly(X135_degree_winds.standardised, degree = 2) + 
             poly(X45_degree_winds.standardised, degree = 2) +
             X135_degree_winds.standardised:X45_degree_winds.standardised+
             Estuary_Type * Drought_Months + (1|Estuary), data = mullet)
r.squaredGLMM(m2) # 0.147
AIC(m2) # -22.726
```

Check assumptions
```{r}
simulationOutput <- simulateResiduals(fittedModel = m2, n = 250)
plot(simulationOutput)

# histograms
hist(simulationOutput$fittedResiduals)
```

```{r}
png("../plots/Model checks/Mullet model 1.png", width = 21, height = 14.8, units = "cm", res = 600)
plot(m2)
dev.off()

png("../plots/Model checks/Mullet model 2.png", width = 21, height = 14.8, units = "cm", res = 600)
hist(resid(m2))
dev.off()

png("../plots/Model checks/Mullet model 3.png", width = 21, height = 14.8, units = "cm", res = 600)
lattice::qqmath(m2)
dev.off()
```


Check significance
```{r}
anova(m2)

summary(m2)
```
Therefore wind is not important for mullet?

```{r}
plot(allEffects(m2))
```

Effect size plot
```{r}
fastdisp(m2)

feEx <- FEsim(m2, 1000)
cbind(feEx[,1] , round(feEx[, 2:4], 3))


plotFEsim(feEx) + 
  theme_bw() + labs(title = "Coefficient Plot of InstEval Model", 
                    x = "Median Effect Estimate", y = "Evaluation Rating")
```

##Now Whiting##
Prepare Data
```{r}
whiting <- subset(my.df, Species == "Whiting")

#m1 <- lmer(CPUE.standardised ~ X135_degree_winds.standardised * X45_degree_winds.standardised + 
#           Estuary_Type + Drought_Months + (1|Estuary), data = bream)
#AIC(m1) #215.42

p3 <- ggplot(whiting, aes(x = X135_degree_winds.standardised,y = X45_degree_winds.standardised, size = log10(CPUE))) + geom_point(alpha = 0.1) +
  theme_classic() + labs(title = "CPUE by lagged Winds")
p3
```

Model
```{r}
m3 <- lmer(log10(CPUE) ~ poly(X135_degree_winds.standardised, degree = 2) + 
             poly(X45_degree_winds.standardised, degree = 2) +
             X135_degree_winds.standardised:X45_degree_winds.standardised+
             Estuary_Type * Drought_Months + (1|Estuary), data = whiting)
r.squaredGLMM(m3) # 0.127
AIC(m3) # 64.26
```

Check assumptions
```{r}
simulationOutput <- simulateResiduals(fittedModel = m3, n = 250)
plot(simulationOutput)

# histograms
hist(simulationOutput$fittedResiduals)
```

```{r}
png("../plots/Model checks/Whiting model 1.png", width = 21, height = 14.8, units = "cm", res = 600)
plot(m3)
dev.off()

png("../plots/Model checks/Whiting model 2.png", width = 21, height = 14.8, units = "cm", res = 600)
hist(resid(m3))
dev.off()

png("../plots/Model checks/Whiting model 3.png", width = 21, height = 14.8, units = "cm", res = 600)
lattice::qqmath(m3)
dev.off()
```


Check significance
```{r}
anova(m3)
summary(m3)
```
Therefore wind is not important for whiting?

```{r}
plot(allEffects(m3))
```

Effect size plot
```{r}
fastdisp(m3)

feEx <- FEsim(m3, 1000)
cbind(feEx[,1] , round(feEx[, 2:4], 3))


plotFEsim(feEx) + 
  theme_bw() + labs(title = "Coefficient Plot of InstEval Model", 
                    x = "Median Effect Estimate", y = "Evaluation Rating")
```

##Now Luderick##
Prepare Data
```{r}
luderick <- subset(my.df, Species == "Luderick")

#m1 <- lmer(CPUE.standardised ~ X135_degree_winds.standardised * X45_degree_winds.standardised + 
#           Estuary_Type + Drought_Months + (1|Estuary), data = bream)
#AIC(m1) #215.42

p4 <- ggplot(luderick, aes(x = X135_degree_winds.standardised,y = X45_degree_winds.standardised, size = log10(CPUE))) + geom_point(alpha = 0.1) +
  theme_classic() + labs(title = "CPUE by lagged Winds")
p4
```

Model
```{r}
m4 <- lmer(log10(CPUE) ~ poly(X135_degree_winds.standardised, degree = 2) + 
             poly(X45_degree_winds.standardised, degree = 2) +
             X135_degree_winds.standardised:X45_degree_winds.standardised+
             Estuary_Type * Drought_Months + (1|Estuary), data = luderick)
r.squaredGLMM(m4) # 0.127
AIC(m4) # 64.26
```

Check assumptions
```{r}
simulationOutput <- simulateResiduals(fittedModel = m4, n = 250)
plot(simulationOutput)

# histograms
hist(simulationOutput$fittedResiduals)
```

```{r}
png("../plots/Model checks/Luderick model 1.png", width = 21, height = 14.8, units = "cm", res = 600)
plot(m4)
dev.off()

png("../plots/Model checks/Luderick model 2.png", width = 21, height = 14.8, units = "cm", res = 600)
hist(resid(m4))
dev.off()

png("../plots/Model checks/Luderick model 3.png", width = 21, height = 14.8, units = "cm", res = 600)
lattice::qqmath(m4)
dev.off()
```


Check significance
```{r}
anova(m4)
summary(m4)
```
Therefore wind is not important for luderick?

```{r}
plot(allEffects(m4))
```

Effect size plot
```{r}
fastdisp(m4)

feEx <- FEsim(m4, 1000)
cbind(feEx[,1] , round(feEx[, 2:4], 3))


plotFEsim(feEx) + 
  theme_bw() + labs(title = "Coefficient Plot of InstEval Model", 
                    x = "Median Effect Estimate", y = "Evaluation Rating")
```

##Now Flathead##
Prepare Data
```{r}
flathead <- subset(my.df, Species == "Flathead")
```

Model
```{r}
m5 <- lmer(log10(CPUE) ~ poly(X135_degree_winds.standardised, degree = 2) + 
             poly(X45_degree_winds.standardised, degree = 2) +
             X135_degree_winds.standardised:X45_degree_winds.standardised+
             Estuary_Type * Drought_Months + (1|Estuary), data = flathead)
r.squaredGLMM(m4) # 0.127
AIC(m5) # 64.26
```

Check assumptions
```{r}
simulationOutput <- simulateResiduals(fittedModel = m5, n = 250)
plot(simulationOutput)

# histograms
hist(simulationOutput$fittedResiduals)
```

```{r}
png("../plots/Model checks/Flathead model 1.png", width = 21, height = 14.8, units = "cm", res = 600)
plot(m5)
dev.off()

png("../plots/Model checks/Flathead model 2.png", width = 21, height = 14.8, units = "cm", res = 600)
hist(resid(m5))
dev.off()

png("../plots/Model checks/Flathead model 3.png", width = 21, height = 14.8, units = "cm", res = 600)
lattice::qqmath(m5)
dev.off()
```


Check significance
```{r}
anova(m5)
summary(m5)
```
Therefore wind is not important for luderick?

```{r}
plot(allEffects(m5))
```

Effect size plot
```{r}
fastdisp(m5)

feEx <- FEsim(m5, 1000)
cbind(feEx[,1] , round(feEx[, 2:4], 3))


plotFEsim(feEx) + 
  theme_bw() + labs(title = "Coefficient Plot of InstEval Model", 
                    x = "Median Effect Estimate", y = "Evaluation Rating")
```

